name: github-pages

on:
  push:
    branches:
    - master

jobs:
  build-deploy:
    runs-on: ubuntu-18.04
    steps:
    - uses: actions/checkout@v1
      with:
        submodules: true

    - name: Get Current Month
      id: current-month
      run: echo "::set-output name=month::$(date '+%m')"

    - name: Cache Hugo Assets
      id: cache-assets
      uses: actions/cache@v1
      with:
        path: /tmp/hugo_cache
        key: hugo-${{ steps.current-month.outputs.month }}
        restore-keys: |
          hugo-${{ steps.current-month.outputs.month }}
          hugo-

# Disabled pending https://github.com/actions/cache/issues/106
#    - name: Cache Hugo Assets
#      id: cache-assets
#      uses: actions/cache@v1
#      with:
#        path: ${{ runner.temp }}/hugo_cache
#        key: hugo-${{ hashfiles('**/filecache/**') }}
#        restore-keys: hugo-
    
    - name: Setup Hugo
      uses: peaceiris/actions-hugo@v2
      with:
        hugo-version: 'latest'
        extended: true

    - name: Stats
      run: |
        wget 'https://track.xyzz.work/index.php?module=API&method=ImageGraph.get&idSite=3&apiModule=UserCountry&apiAction=getCountry&token_auth=$MATOMO_API&graphType=horizontalBar&period=month&date=today&width=500&height=250' -O content/docs/appendix/meta/stats/img/visits_country.png
        wget 'https://track.xyzz.work/index.php?module=API&method=ImageGraph.get&idSite=3&apiModule=VisitsSummary&apiAction=get&token_auth=$MATOMO_API&graphType=evolution&period=day&date=previous30&width=500&height=250' -O content/docs/appendix/meta/stats/img/visits_summary.png
      env:
        MATOMO_API: ${{ secrets.MATOMO_API }}

    - name: Build
      run: hugo
                                                                                
    - name: Deploy
      uses: peaceiris/actions-gh-pages@v2
      env:
        ACTIONS_DEPLOY_KEY: ${{ secrets.ACTIONS_DEPLOY_KEY }}
        PUBLISH_BRANCH: gh-pages
        PUBLISH_DIR: ./public
      with:
        forceOrphan: true
